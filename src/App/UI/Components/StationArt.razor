<div @attributes="@AdditionalAttributes" class=@ClassNames.Combine(AdditionalAttributes, "aspect-square block isolate overflow-hidden relative ring-accent-subtle rounded-sm shadow-sm shrink-0 text-gray-300")>
    <div class="absolute aspect-square bg-crust flex h-full inset-0 items-center justify-center overflow-hidden shrink-0 w-full -z-10">
        @if (Station?.IconUrl is null)
        {
            <Icon class="opacity-75" Name="@IconName.Radio" Size="@TextSize.ExtraLarge6" />
        }
        else
        {
            <img class="object-cover object-center origin-center shrink-0" src="@Station.IconUrl" loading="@Loading.ToAttributeValue()" />
        }
    </div>

    <div class="bg-linear-to-b from-transparent from-70% via-gray-700/10 via-80% to-gray-800/60 flex flex-row h-full w-full z-0">
        <div class="flex flex-row group items-end justify-between p-2.5 w-full">
            @if (IsMetaVisible && Station is not null)
            {
                <Icon class=@ClassNames.Combine("drop-shadow-md font-bold", Station.IsHls ? "visible" : "invisible") Name="@IconName.Hls" Size="@TextSize.ExtraLarge2" />
            }

            @if (IsInteractive && Station is not null)
            {
                <div class=@ClassNames.Combine("aspect-square bg-accent cursor-pointer drop-shadow-sm ease-in flex flex-row items-center justify-center p-2.5 rounded-full ring-accent-subtle shadow-md transition-opacity transition-visibility active:ring-accent focus:ring-accent focus-visible:ring-accent", PlayerContext.Station?.Id == Station.Id ? "opacity-100 visible" : "invisible opacity-0 group-hover:opacity-100 group-hover:visible") role="button" title="@(PlayerContext.Station?.Id == Station.Id ? "Stop" : "Play")" @onclick="@OnPlayerToggle" @onclick:preventDefault @onclick:stopPropagation>
                    <Icon Name="@(PlayerContext.Station?.Id == Station.Id ? IconName.Stop : IconName.PlayArrow)" Size="@TextSize.ExtraLarge3" />
                </div>
            }
        </div>
    </div>
</div>

@code {

    [Parameter(CaptureUnmatchedValues = true)]
    public IReadOnlyDictionary<string, object>? AdditionalAttributes { get; init; }

    [CascadingParameter]
    public PlayerContext PlayerContext { get; init; }

    [EditorRequired]
    [Parameter]
    public Station? Station { get; init; }

    [Parameter]
    public bool IsInteractive { get; init; }

    [Parameter]
    public bool IsMetaVisible { get; init; } = true;

    [Parameter]
    public ImageLoadStrategy Loading { get; init; }

    private async Task OnPlayerToggle()
    {
        if (Station is null)
        {
            return;
        }

        if (PlayerContext.Station?.Id == Station.Id)
        {
            await PlayerContext.Update(default);
            return;
        }

        await PlayerContext.Update(Station);
    }

}